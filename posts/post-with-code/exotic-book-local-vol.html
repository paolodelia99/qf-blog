<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-02-11">

<title>Hedging a book of exotic options with different maturities – blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-afa37c5c79185640b9c231024f4fe5ea.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/paolodelia99"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/paolo-d-elia/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Hedging a book of exotic options with different maturities</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Quantitative finance</div>
                <div class="quarto-category">Hedging</div>
                <div class="quarto-category">Exotic options</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 11, 2026</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In this notebook, we continue on the track to study the track of hedging in the world of FX option still from a trader sitting in a exotic desk in a investment bank. As we’ve seen in the previous notebooks (<a href="../../posts/post-with-code/exotic-book.html">Hedging a book of exotics options</a>) we have cover the basics on how to hedge a book of FX exotics, both in the case where we are hedging under the Black-Scholes model and in the case where we have a volatility smile and hedge options with the same expiration using the VV method (<a href="../../posts/post-with-code/exotic-book-vanna-volga.html">Hedging a book of exotics options using the Vanna-Volga</a>), in this notebook we are going to take a even further step since we are going to leverage the whole IV surface to hedge our portfolio made of different options with different strikes and expirations. In this case, I’ve decided to leverage the local volatility model and price using the Finite Difference method. The assets that we are considering are thus under the following dynamics:</p>
<p><span class="math display">\[
\begin{align*}
dS_t &amp;= (r_d - r_f) S_t \, dt + \sigma(S, t) S_t \, dW_t^d, \\
dB^d_t &amp;= r_d B^d_t\, dt, \\
dB^f_t &amp;= r_f B^f_t\, dt
\end{align*}
\]</span></p>
<section id="market-data" class="level1">
<h1>Market Data</h1>
<p>Let’s assume that we are an USD based desk and we are dealing with EURUSD exotics. The initial market data at time <span class="math inline">\(t = 0\)</span> is the following</p>
<p><span class="math display">\[
\begin{align*}
    S_0 &amp;= 1.18 \\
    Date(Today) &amp;= 12/12/2025 \\
    r_{USD} &amp;= 0.03 \\
    r_{EUR} &amp;= 0.02 \\
\end{align*}
\]</span></p>
<p>With the following Implied Vol surface</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;"><span class="math inline">\(10\Delta p\)</span></th>
<th style="text-align: left;"><span class="math inline">\(25\Delta p\)</span></th>
<th style="text-align: left;">ATM</th>
<th style="text-align: left;"><span class="math inline">\(25\Delta c\)</span></th>
<th style="text-align: left;"><span class="math inline">\(10\Delta c\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>1W</strong></td>
<td style="text-align: left;">13.50%</td>
<td style="text-align: left;">12.00%</td>
<td style="text-align: left;">9.50%</td>
<td style="text-align: left;">8.50%</td>
<td style="text-align: left;">9.50%</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>1M</strong></td>
<td style="text-align: left;">13.00%</td>
<td style="text-align: left;">11.50%</td>
<td style="text-align: left;">9.00%</td>
<td style="text-align: left;">8.00%</td>
<td style="text-align: left;">9.00%</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>3M</strong></td>
<td style="text-align: left;">12.50%</td>
<td style="text-align: left;">11.00%</td>
<td style="text-align: left;">9.50%</td>
<td style="text-align: left;">8.50%</td>
<td style="text-align: left;">9.50%</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>1Y</strong></td>
<td style="text-align: left;">12.00%</td>
<td style="text-align: left;">10.50%</td>
<td style="text-align: left;">10.00%</td>
<td style="text-align: left;">9.50%</td>
<td style="text-align: left;">10.50%</td>
</tr>
</tbody>
</table>
<p>For the sake of simplicity we consider that the interest rate term structures for the USD and EUR are both flat</p>
<blockquote class="blockquote">
<p>Note in the FX option world, IVs are quoted as a delta-vol pairs for each maturity.</p>
</blockquote>
<div id="3cba25b6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>EUR_USD <span class="op">=</span> <span class="fl">1.18</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> ql.Date(<span class="dv">12</span>, ql.December, <span class="dv">2025</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>ref_date <span class="op">=</span> today</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>calendar <span class="op">=</span> ql.NullCalendar()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> ql.Actual365Fixed()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>r_d <span class="op">=</span> <span class="fl">0.0325</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>r_f <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>ql.Settings.instance().evaluationDate <span class="op">=</span> today</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e31befb0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>spot_quote <span class="op">=</span> ql.SimpleQuote(EUR_USD)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>spot_handle <span class="op">=</span> ql.QuoteHandle(spot_quote)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>deltas <span class="op">=</span> [<span class="op">-</span><span class="fl">0.10</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.25</span>, <span class="fl">0.10</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>option_types <span class="op">=</span> [ql.Option.Put, ql.Option.Put, ql.Option.Call, ql.Option.Call, ql.Option.Call]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>maturity_1y <span class="op">=</span> calendar.advance(today, ql.Period(<span class="dv">1</span>, ql.Years))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>maturity_3m <span class="op">=</span> calendar.advance(today, ql.Period(<span class="dv">3</span>, ql.Months))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>maturity_6m <span class="op">=</span> calendar.advance(today, ql.Period(<span class="dv">6</span>, ql.Months))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>maturity_1m <span class="op">=</span> calendar.advance(today, ql.Period(<span class="dv">1</span>, ql.Months))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>maturity_1w <span class="op">=</span> calendar.advance(today, ql.Period(<span class="dv">1</span>, ql.Weeks))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>maturities <span class="op">=</span> [</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    maturity_1w,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    maturity_1m,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    maturity_3m,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    maturity_1y</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> [dc.yearFraction(today, m) <span class="cf">for</span> m <span class="kw">in</span> maturities]</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Vol surface</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>ivs <span class="op">=</span> np.array([</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0.10P, 0.25P, ATM,  0.25C, 0.10C</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.135</span>, <span class="fl">0.12</span>,  <span class="fl">0.095</span>, <span class="fl">0.090</span>, <span class="fl">0.095</span>],  <span class="co"># 1W </span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.130</span>, <span class="fl">0.115</span>, <span class="fl">0.090</span>, <span class="fl">0.080</span>, <span class="fl">0.090</span>],  <span class="co"># 1M</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.125</span>, <span class="fl">0.110</span>, <span class="fl">0.095</span>, <span class="fl">0.085</span>, <span class="fl">0.095</span>],  <span class="co"># 3M</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.120</span>, <span class="fl">0.105</span>, <span class="fl">0.100</span>, <span class="fl">0.095</span>, <span class="fl">0.105</span>],  <span class="co"># 1Y</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9fa6180a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rates TS</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>domestic_ts <span class="op">=</span> ql.YieldTermStructureHandle(ql.FlatForward(today, r_d, dc))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>foreign_ts <span class="op">=</span> ql.YieldTermStructureHandle(ql.FlatForward(today, r_f, dc))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="30d25e89" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Discount curves</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>eur_dates <span class="op">=</span> [ql.Date(<span class="dv">27</span>, ql.August, <span class="dv">2025</span>), ql.Date(<span class="dv">27</span>, ql.August, <span class="dv">2026</span>), ql.Date(<span class="dv">27</span>, ql.August, <span class="dv">2027</span>)]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>eur_dfs <span class="op">=</span> [<span class="fl">1.0</span>, <span class="fl">0.98</span>, <span class="fl">0.95</span>]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>eur_curve <span class="op">=</span> ql.DiscountCurve(eur_dates, eur_dfs, dc)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>eur_curve.enableExtrapolation()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>eur_disc_ts <span class="op">=</span> ql.YieldTermStructureHandle(eur_curve)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>usd_dates <span class="op">=</span> [ql.Date(<span class="dv">27</span>, ql.August, <span class="dv">2025</span>), ql.Date(<span class="dv">27</span>, ql.August, <span class="dv">2026</span>), ql.Date(<span class="dv">27</span>, ql.August, <span class="dv">2027</span>)]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>usd_dfs <span class="op">=</span> [<span class="fl">1.0</span>, <span class="fl">0.985</span>, <span class="fl">0.96</span>]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>usd_curve <span class="op">=</span> ql.DiscountCurve(usd_dates, usd_dfs, dc)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>usd_curve.enableExtrapolation()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>usd_disc_ts <span class="op">=</span> ql.YieldTermStructureHandle(usd_curve)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s also suppose that the following discount curve:</p>
<div id="edc62631" class="cell" data-execution_count="181">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="exotic-book-local-vol_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Since we have a sticky delta volatility surface, we need to turn the surface into a sticky strike volatility surface in order to make <code>QuantLib</code> make use of those IVs when pricing the exotics. To do that let’s use the <code>create_strike_iv_surf</code> helper function defined above. <code>create_strike_iv_surf</code> uses the <code>ql.BlackDeltaCalculator</code> class which allows us to get the strike from the delta-vol quote according the specific delta quote convetion that we are using.</p>
<div id="12be16fe" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>strikes <span class="op">=</span> create_strike_iv_surf(EUR_USD, usd_curve, eur_curve, deltas, option_types, times, ivs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The corresponding strikes for each <span class="math inline">\((\Delta,T)\)</span> tuple are:</p>
<div id="a18bf630" class="cell" data-execution_count="183">
<div class="cell-output cell-output-display" data-execution_count="183">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">10D P</th>
<th data-quarto-table-cell-role="th">25D P</th>
<th data-quarto-table-cell-role="th">ATM</th>
<th data-quarto-table-cell-role="th">25D C</th>
<th data-quarto-table-cell-role="th">10D C</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1W</th>
<td>1.152382</td>
<td>1.167127</td>
<td>1.180212</td>
<td>1.190167</td>
<td>1.200282</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1M</th>
<td>1.125401</td>
<td>1.154811</td>
<td>1.180866</td>
<td>1.199518</td>
<td>1.221262</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3M</th>
<td>1.093388</td>
<td>1.140628</td>
<td>1.182536</td>
<td>1.216533</td>
<td>1.256383</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1Y</th>
<td>1.025369</td>
<td>1.112431</td>
<td>1.189692</td>
<td>1.268784</td>
<td>1.363115</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Since, now we have a set of IV with different strikes for each expiration, we need to find a way to build the IV surface using this data. One efficient and common way to do that is using the Andersen-Huge interpolation <span class="citation" data-cites="vol-interpol">(see <a href="#ref-vol-interpol" role="doc-biblioref">Andreasen and Huge 2010</a>)</span> method, which allows us to achieve this goal. In a nuthsell, the Andreasen and Huge have introduced an efficient and arbitrage free volatility interpolation method based on a one step finite difference implicit Euler scheme applied to a local volatility parametrization. Probably the most notable use case is the generation of a local volatility surface from a set of option quotes.</p>
<p>QuantLib provides us with a series of classes that can help us to build both the IV and the local surface from the IV data, using the Andersen-Huge method. First and foremost, we need to build a calibration set, which is basically a list of Tuple made by the option and the iv relative to that option <code>(option, ivs_quote)</code>, and then we can create an instance of the <code>ql.AndersenHugeVolatilityInterpl</code> with the calibration set created, that is the class that is going to handle the interpolation. Then we need to create the relative Implied vol and Local vol adapter the <code>ql.AndersenHugeVolatilityAdapter</code> and the <code>ql.AndersenHugeLocalAdapter</code> respectively. Those are the instances that resprents the BlackVarianceTermStructure and the LocalVolTermStructure that we need to further wrap into a <code>RelinkableHandle</code>.</p>
<p>Why a <code>RenilableHandle</code> you might ask? Well it’s because it will come in handyh to us when calculating the sensitivities, rembember a <code>RelinkableHandle</code> can be link to another term structure after it is first created, unlike a plain handle.</p>
<div id="a3ff9c3f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration of vol surfaces</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calibrate_vol_surface(strikes: Union[List[List[<span class="bu">float</span>]], np.ndarray], </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                          options: List[ql.Option],</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                          maturities: List[<span class="bu">float</span>], </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                          ivs: np.array</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                        ) <span class="op">-&gt;</span> Tuple[ql.BlackVolTermStructure, ql.LocalVolTermStructure]:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Calibrate the given ivs quotes and build a BlackVolTermStructure and a LocalVolTermStructure</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">        strikes (Union[List[List[float]], np.ndarray]): the strikes of the volatility surface</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">        options (List[ql.Option]): the types of option a specific strike is referring to</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">        maturities (List[float]): list of maturieties of the vol surface</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">        ivs (np.ndarray): the iv surface data</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Return:</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">        ql.Tuple[ql.BlackVolTermStructure, ql.LocalVolTermStructure]: tuple contaning the calibrate black vol term structure </span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">                                                                    and the local vol term structure</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    calibration_set <span class="op">=</span> ql.CalibrationSet()</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    n, m <span class="op">=</span> <span class="bu">len</span>(maturities), <span class="bu">len</span>(options)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(m):</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            payoff <span class="op">=</span> ql.PlainVanillaPayoff(options[i], strikes[i][j])</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            maturity <span class="op">=</span> ql.EuropeanExercise(maturities[i])</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>            calibration_set.push_back((ql.VanillaOption(payoff, maturity), ql.SimpleQuote(ivs[i][j])))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    ah_interpolation <span class="op">=</span> ql.AndreasenHugeVolatilityInterpl(calibration_set, <span class="op">\</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                            spot_handle, domestic_ts, foreign_ts)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    ah_vol_surf <span class="op">=</span> ql.AndreasenHugeVolatilityAdapter(ah_interpolation) <span class="co"># IV surface</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    ah_local_vol <span class="op">=</span> ql.AndreasenHugeLocalVolAdapter(ah_interpolation) <span class="co"># LV surface</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ah_vol_surf, ah_local_vol</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>ah_vol_surf, ah_local_vol <span class="op">=</span> calibrate_vol_surface(strikes, option_types, maturities, ivs)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>black_vol_surf_handle <span class="op">=</span> ql.RelinkableBlackVolTermStructureHandle(ah_vol_surf)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>local_vol_surf_handle <span class="op">=</span> ql.RelinkableLocalVolTermStructureHandle(ah_local_vol)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now that we have constructed the vol surfaces, let’s now visualized how they look:</p>
<div id="820268ae" class="cell" data-execution_count="185">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="exotic-book-local-vol_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Just a reminder <span class="math inline">\(IV_{\text{surface}} \ne LV_{\text{surface}}\)</span>, they are related but they are not the same thing. IVs represent a sort of estimate of the average future volatility of the underlying during the option’s lifetime. In a way, IVs is a “global” measure of volatility, in contrast to the local volatility <span class="math inline">\(\sigma_{LV}\)</span> at any spot price and time.</p>
<p>Since we are using the local vol model, one way to price option is by using the Finite Difference method. QuantLib provides us with the <code>FdBlackScholesBarrierEngine</code> class to achieve that, keep in mind that we need to set <code>useLocalVol=True</code>, thus we can use the local volatility function when running the pricing engine.</p>
<div id="a6adddb4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> ql.FdBlackScholesBarrierEngine(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    process,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">200</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">400</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    ql.FdmSchemeDesc.Douglas(),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span>, <span class="co"># localVol has to be True</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="exotics-book" class="level2">
<h2 class="anchored" data-anchor-id="exotics-book">Exotics Book</h2>
<p>Here’s how the trader book is composed of:</p>
<p>1st Barrier</p>
<p><span class="math display">\[
\begin{align*}
    \text{Option type} &amp;= \text{Call} \\
    \text{Notional} &amp;= \$1000000 \\
    T &amp;= 1.0 \\
    \text{Barrier} &amp;= 1.30 \\
    \text{Strike} &amp;= 25\Delta c \\
    \text{Barrier Type} &amp;= \text{Up and Out}
\end{align*}
\]</span></p>
<div id="6799165d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Barrier 1</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>notional <span class="op">=</span> <span class="dv">1_000_000</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>barrier <span class="op">=</span> <span class="fl">1.30</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>barrier_type <span class="op">=</span> ql.Barrier.UpOut</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>exercise <span class="op">=</span> ql.EuropeanExercise(maturity_1y)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>strike <span class="op">=</span> strike_from_delta(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    EUR_USD,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.25</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    times[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    ql.Option.Call,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    ivs[<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">2</span>],</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    usd_curve,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    eur_curve</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>barrier_25d_130b <span class="op">=</span> call_barrier_factory.get_option(strike, exercise, barrier, barrier_type)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>barrier_1 <span class="op">=</span> BarrierPosition(barrier_25d_130b, notional, NullInstrument())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>2nd Barrier</p>
<p><span class="math display">\[
\begin{align*}
    \text{Option type} &amp;= \text{Call} \\
    \text{Notional} &amp;= \$2000000 \\
    T &amp;= 0.5 \\
    \text{Barrier} &amp;= 1.08 \\
    \text{Strike} &amp;= 25\Delta c \\
    \text{Barrier Type} &amp;= \text{Down and Out}
\end{align*}
\]</span></p>
<div id="04b66cca" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Barrier 2</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>notional <span class="op">=</span> <span class="dv">2_000_000</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>barrier <span class="op">=</span> <span class="fl">1.08</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>barrier_type <span class="op">=</span> ql.Barrier.DownOut</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>exercise <span class="op">=</span> ql.EuropeanExercise(maturity_6m)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>strike <span class="op">=</span> strike_from_delta(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    EUR_USD,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.25</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    dc.yearFraction(today, maturity_6m),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    ql.Option.Call,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.09</span>, <span class="co"># Interpolated value</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    usd_curve,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    eur_curve</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>barrier_25d_108b <span class="op">=</span> call_barrier_factory.get_option(strike, exercise, barrier, barrier_type)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>barrier_2 <span class="op">=</span> BarrierPosition(barrier_25d_108b, notional, NullInstrument())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>3rd Barrier</p>
<p><span class="math display">\[
\begin{align*}
    \text{Option type} &amp;= \text{Call} \\
    \text{Notional} &amp;= \$1000000 \\
    T &amp;= 0.25 \\
    \text{Barrier} &amp;= 1.20 \\
    \text{Strike} &amp;= 25\Delta c \\
    \text{Barrier Type} &amp;= \text{Up and In}
\end{align*}
\]</span></p>
<div id="8b63faea" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Barrier 3</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>notional <span class="op">=</span> <span class="dv">1_000_000</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>barrier <span class="op">=</span> <span class="fl">1.20</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>barrier_type <span class="op">=</span> ql.Barrier.UpIn</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>exercise <span class="op">=</span> ql.EuropeanExercise(maturity_3m)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>strike <span class="op">=</span> strike_from_delta(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    EUR_USD,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.25</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    dc.yearFraction(today, maturity_3m),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    ql.Option.Call,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    ivs[<span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">2</span>],</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    usd_curve,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    eur_curve</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>call_vanilla_factory <span class="op">=</span> FxVanillaOptionFactory(spot_handle, maturity_1y, ql.Option.Call)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>barrier_25d_120b <span class="op">=</span> call_barrier_factory.get_option(strike, exercise, barrier, barrier_type)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>backup_vanilla <span class="op">=</span> call_vanilla_factory.get_option(strike)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>FxVanillaOptionFactory.assign_analyitcal_price_engine(backup_vanilla, process_25c)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>barrier_3 <span class="op">=</span> BarrierPosition(barrier_25d_120b, notional, backup_vanilla)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>4th Barrier</p>
<p><span class="math display">\[
\begin{align*}
    \text{Option type} &amp;= \text{Put} \\
    \text{Notional} &amp;= \$1000000 \\
    T &amp;= 0.25 \\
    \text{Barrier} &amp;= 1.05 \\
    \text{Strike} &amp;= 25\Delta p \\
    \text{Barrier Type} &amp;= \text{Down and Out}
\end{align*}
\]</span></p>
<div id="d269693c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Barrier 4</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>notional <span class="op">=</span> <span class="dv">1_000_000</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>barrier <span class="op">=</span> <span class="fl">1.05</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>barrier_type <span class="op">=</span> ql.Barrier.DownOut</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>exercise <span class="op">=</span> ql.EuropeanExercise(maturity_3m)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>strike <span class="op">=</span> strike_from_delta(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    EUR_USD,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="fl">0.25</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    dc.yearFraction(today, maturity_3m),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    ql.Option.Put,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    ivs[<span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    usd_curve,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    eur_curve</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>barrier_25d_105b <span class="op">=</span> put_barrier_factory.get_option(strike, exercise, barrier, barrier_type)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>barrier_4 <span class="op">=</span> BarrierPosition(barrier_25d_105b, notional, NullInstrument())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>5th Barrier</p>
<p><span class="math display">\[
\begin{align*}
    \text{Option type} &amp;= \text{Put} \\
    \text{Notional} &amp;= \$1000000 \\
    \text{Barrier} &amp;= 1.25 \\
    T &amp;= 0.0833 \\
    \text{Strike} &amp;= 25\Delta p \\
    \text{Barrier Type} &amp;= \text{Up and Out}
\end{align*}
\]</span></p>
<div id="c7b5ce4d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Barrier 5</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>notional <span class="op">=</span> <span class="dv">2_000_000</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>barrier <span class="op">=</span> <span class="fl">1.25</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>barrier_type <span class="op">=</span> ql.Barrier.UpOut</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>exercise <span class="op">=</span> ql.EuropeanExercise(maturity_1m)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>strike <span class="op">=</span> strike_from_delta(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    EUR_USD,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="fl">0.25</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    dc.yearFraction(today, maturity_1m),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    ql.Option.Put,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    ivs[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    usd_curve,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    eur_curve</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>barrier_25d_105b <span class="op">=</span> put_barrier_factory.get_option(strike, exercise, barrier, barrier_type)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>barrier_5 <span class="op">=</span> BarrierPosition(barrier_25d_105b, notional, NullInstrument())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="259f3ccc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>book: List[BarrierPosition] <span class="op">=</span> [barrier_1, barrier_2, barrier_3, barrier_4, barrier_5]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ins <span class="kw">in</span> book:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    FxBarrierOptionFactory.assign_price_engine(ins.instrument, engine)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we have setup our book, let’s see what’s the premium on those options.</p>
<div id="2e7047b1" class="cell" data-execution_count="195">
<div class="cell-output cell-output-stdout">
<pre><code>Barrier 1, price $260.39
Barrier 2, price $26721.44
Barrier 3, price $7822.55
Barrier 4, price $4510.61
Barrier 5, price $13603.77</code></pre>
</div>
</div>
<div id="06ea7785" class="cell" data-execution_count="196">
<div class="cell-output cell-output-stdout">
<pre><code>The total book value is ${book_value}</code></pre>
</div>
</div>
</section>
</section>
<section id="bucketed-sensitivities" class="level1">
<h1>Bucketed sensitivities</h1>
<p>When dealing with vol surfaces or smiles, to calculate the sensitivity w.r.t. the volatility does not result trival as when we are dealing with a single vol like in BS model. As shown in the Hedging a book of exotic options with VV method, in case we have a smile we can calculate the sensitivities to the various movements of the volatility smile (paralallel shift, varying the skew, and the curvature), and those ideas can be also applied to the whole vol surface.</p>
<p>Another possible way, to get those vega sensitivities is to calculate how the prices are sensible to each single IV variation, in this way we get the so called bucket sensitivites.</p>
<p>For example we want to know how the price of an exotic is sensible to the variation to the <span class="math inline">\(\sigma_{(0.10\Delta P, 1M)}\)</span>. To the get that we can use the forward finte difference formula:</p>
<p><span class="math display">\[
\frac{\partial V}{\partial \sigma_{(0.10\Delta P, 1M)}} = \frac{V(\sigma_{(0.10\Delta P, 1M)} + \varepsilon, \cdot) - V(\sigma_{(0.10\Delta P, 1M)}, \cdot)}{\varepsilon}
\]</span></p>
<p>By repeating this process for all vols of the IV surface we get a matrix of the bucket sensitivities:</p>
<p><span class="math display">\[
\text{Bucket Sensitivities} = \left[
\begin{array}{c|cccc}
    &amp; \text{10$\Delta$ P} &amp; \text{25$\Delta$ P} &amp; \text{ATM} &amp; \text{25$\Delta$ C} &amp; \text{10$\Delta$ C} \\
    \hline
    \text{1W}   &amp; s_{11} &amp; s_{12} &amp; s_{13} &amp; s_{14} &amp; s_{15} \\
    \text{1M}   &amp; s_{21} &amp; s_{22} &amp; s_{23} &amp; s_{24} &amp; s_{25} \\
    \text{3M}  &amp; s_{31} &amp; s_{32} &amp; s_{33} &amp; s_{34} &amp; s_{35} \\
    \text{1Y}  &amp; s_{41} &amp; s_{42} &amp; s_{43} &amp; s_{44}  &amp; s_{45} \\
\end{array}
\right]
\]</span></p>
<p>The methodology to use to calculate the sensitivities w.r.t. the volatility surface is up the trader/trading desk, on how they want those sensitivities …</p>
<blockquote class="blockquote">
<p>TODO: add risk surface explanation</p>
</blockquote>
<p>To visualized the effect of those single bumps of the single IVs, let’s for example bump by <span class="math inline">\(1\%\)</span> the ATM vol with maturity 1 year, and visualized how the IV and LV surfaces are changing.</p>
<div id="9b9f00bd" class="cell" data-execution_count="198">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="exotic-book-local-vol_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The IV surface does change a bit, but where we can see a big changment is in LV surface where a new hump appears at the end of the surface. Let’s now see how the prices of the exotics have changed with this new vol surfaces.</p>
<div id="e4d50989" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>new_premiums <span class="op">=</span> [opt.NPV() <span class="cf">for</span> opt <span class="kw">in</span> book]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>new_premiums</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="199">
<pre><code>[555.7614339685688,
 31789.433532155144,
 7822.54562563613,
 4510.6110117102935,
 13603.771705059622]</code></pre>
</div>
</div>
<div id="5950367b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>np.array(premiums) <span class="op">-</span> np.array(new_premiums)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="200">
<pre><code>array([ -295.3701985 , -5067.99548249,     0.        ,     0.        ,
           0.        ])</code></pre>
</div>
</div>
<p>As we can see the only options where the price has varied is the 1st barrier, which is the only barrier that has expiration time 1Y. … You might wonder what does bump another vol with shorted maturity, will that affect also the exotics with maturities greater than that maturity? Let’s bump for example by 1bp the ATM, 1M implied vol and see the effects on the other exotics prices.</p>
<div id="891a84a8" class="cell" data-execution_count="202">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="exotic-book-local-vol_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="dd51d9b2" class="cell" data-execution_count="203">
<div class="cell-output cell-output-stdout">
<pre><code>Barrier 1, ATM 1M IV bump sensitivity: $ -0.10
Barrier 2, ATM 1M IV bump sensitivity: $ 17.19
Barrier 3, ATM 1M IV bump sensitivity: $ 4.48
Barrier 4, ATM 1M IV bump sensitivity: $ -22.66
Barrier 5, ATM 1M IV bump sensitivity: $ -565.39</code></pre>
</div>
</div>
<p>Now we see how all options in the book have been impacted by this vol bump, that’s because all the options in the book have an expiration after 1Y, thus this will impact their price. Of course Barrier 5 will be the one with more price impact, since it expires in 1 month, but we can see that also in options expirying in 3 months and 6 months there is a price impact.</p>
<p>Let’s apply the process above for all the IVs in the original IV surface and calculate those bucket sensitivities.</p>
<div id="e315fecb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>bucket_sens <span class="op">=</span> np.zeros_like(ivs)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>delta_vol <span class="op">=</span> <span class="fl">1.0e-08</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(ivs)):</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(ivs[<span class="dv">0</span>])):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        ivs[i, j] <span class="op">+=</span> delta_vol</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        tmp_strikes <span class="op">=</span> create_strike_iv_surf(EUR_USD, usd_curve, eur_curve, deltas, option_types, times, ivs)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        new_ah_vol_surf, new_ah_local_vol <span class="op">=</span> calibrate_vol_surface(tmp_strikes, option_types, maturities, ivs)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        black_vol_surf_handle.linkTo(new_ah_vol_surf)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        local_vol_surf_handle.linkTo(new_ah_local_vol)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        new_book_value <span class="op">=</span> <span class="bu">sum</span>([opt.NPV() <span class="cf">for</span> opt <span class="kw">in</span> book])</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        bucket_sens[i, j] <span class="op">=</span> (new_book_value <span class="op">-</span> book_value) <span class="op">/</span> delta_vol</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        ivs[i, j] <span class="op">-=</span> delta_vol</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fc9a0139" class="cell" data-execution_count="205">
<div class="cell-output cell-output-display" data-execution_count="205">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">10D P</th>
<th data-quarto-table-cell-role="th">25D P</th>
<th data-quarto-table-cell-role="th">ATM</th>
<th data-quarto-table-cell-role="th">25D C</th>
<th data-quarto-table-cell-role="th">10D C</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1W</th>
<td>-1878.530020</td>
<td>5996.552500</td>
<td>-7096.302579</td>
<td>3011.398803</td>
<td>974.274008</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1M</th>
<td>-11133.617227</td>
<td>168080.302683</td>
<td>41107.244760</td>
<td>-11645.406630</td>
<td>1430.459088</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3M</th>
<td>-153599.417536</td>
<td>173253.199318</td>
<td>40819.460264</td>
<td>250610.804505</td>
<td>49760.293768</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1Y</th>
<td>15323.454136</td>
<td>-176753.786945</td>
<td>341937.783378</td>
<td>346704.848926</td>
<td>-71231.295442</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>How do we hedge those bucketed sensitivities? Well, we can do it with plain vanilla options, …</p>
<p><span class="math display">\[
s_{ij} = w_{ij} \frac{\partial C_{BS}(\sigma{ij})}{\partial \sigma_{ij}}  \Rightarrow w_{ij} = \frac{s_{ij}}{\frac{\partial C_{BS}(\sigma{ij})}{\partial \sigma_{ij}}}
\]</span></p>
<div id="c81f9a23" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>vanilla_options <span class="op">=</span> np.zeros_like(bucket_sens).tolist()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(vanilla_options)):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(vanilla_options[<span class="dv">0</span>])):</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        maturity <span class="op">=</span> maturities[i]</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        option_type <span class="op">=</span> option_types[j]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        strike <span class="op">=</span> strikes[i, j]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        process <span class="op">=</span> ql.GarmanKohlagenProcess(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            spot_handle,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>            foreign_ts,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>            domestic_ts,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>            ql.BlackVolTermStructureHandle(</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                ql.BlackConstantVol(ref_date, calendar, ivs[i, j], dc)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        payoff <span class="op">=</span> ql.PlainVanillaPayoff(option_type, strike)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        vanilla_options[i][j] <span class="op">=</span> ql.VanillaOption(payoff, ql.EuropeanExercise(maturity))</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        vanilla_options[i][j].setPricingEngine(ql.AnalyticEuropeanEngine(process))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="01eab1c0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>vegas <span class="op">=</span> np.array([[opt.vega() <span class="op">*</span> notional <span class="cf">for</span> opt <span class="kw">in</span> row] <span class="cf">for</span> row <span class="kw">in</span> vanilla_options])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2a6969f0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>vega_weights <span class="op">=</span> bucket_sens <span class="op">/</span> vegas</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> np.printoptions(precision<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(vega_weights)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[-0.033  0.058 -0.054  0.029  0.017]
 [-0.094  0.78   0.15  -0.052  0.012]
 [-0.778  0.477  0.088  0.656  0.231]
 [ 0.04  -0.251  0.372  0.446 -0.159]]</code></pre>
</div>
</div>
<p>Now that we have found the weight for all the vanillas, let’s now reduce the total <span class="math inline">\(\Delta\)</span> exposure of our portfolio. The weight for the spot position hedge is given by</p>
<p><span class="math display">\[
w_{\Delta} = \frac{\frac{\partial \text{book}}{\partial S}}{\sum_{ij} \frac{\partial C_{BS}^{ij}}{\partial S}}
\]</span></p>
<div id="54aa06bb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>spot_change <span class="op">=</span> <span class="fl">0.01</span> <span class="op">*</span> spot_quote.value() <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>delta_book <span class="op">=</span> <span class="bu">sum</span>([pos.sensitivity(delta, h<span class="op">=</span>spot_change) <span class="cf">for</span> pos <span class="kw">in</span> book])</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>delta_vanillas <span class="op">=</span> <span class="bu">sum</span>([<span class="bu">sum</span>([opt.delta() <span class="op">*</span> v_w <span class="op">*</span> notional <span class="cf">for</span> opt, v_w <span class="kw">in</span> <span class="bu">zip</span>(row, v_row)]) <span class="cf">for</span> row, v_row <span class="kw">in</span> <span class="bu">zip</span>(vanilla_options, vega_weights)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="62820f2c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>hedging_delta_weight <span class="op">=</span> delta_book <span class="op">/</span> delta_vanillas</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>hedging_delta_weight</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="212">
<pre><code>np.float64(-0.23937887076554554)</code></pre>
</div>
</div>
<div id="767b1cac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>vanillas_premiums <span class="op">=</span> [[opt.NPV() <span class="op">*</span> v_w <span class="op">*</span> notional <span class="cf">for</span> opt, v_w <span class="kw">in</span> <span class="bu">zip</span>(row, v_row)] <span class="cf">for</span> row, v_row <span class="kw">in</span> <span class="bu">zip</span>(vanilla_options, vega_weights)]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>spot_hedge_usd <span class="op">=</span> hedging_delta_weight <span class="op">*</span> notional <span class="op">*</span> spot_handle.value()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>hedging_str_premium <span class="op">=</span> np.<span class="bu">sum</span>(vanillas_premiums) <span class="op">+</span> spot_hedge_usd</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>bank_account_value <span class="op">=</span> <span class="op">-</span> hedging_str_premium <span class="op">+</span> np.<span class="bu">sum</span>(premiums)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1c41b5e8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>port_value <span class="op">=</span> [hedging_str_premium <span class="op">-</span> np.<span class="bu">sum</span>(premiums) <span class="op">+</span> bank_account_value]</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The portfolio value at time t = 0 is </span><span class="sc">{</span>port_value[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>The portfolio value at time t = 0 is 0.0</code></pre>
</div>
</div>
<section id="changes-of-the-hedging-portfolio-with-the-changes-of-the-market-conditions" class="level2">
<h2 class="anchored" data-anchor-id="changes-of-the-hedging-portfolio-with-the-changes-of-the-market-conditions">Changes of the hedging portfolio with the changes of the market conditions</h2>
<p>Now that we have setup our hedging portfolio see verify how its will change as the spot and vol surface change. Let’s assume that in a 2-day period the spot went go down by 200 pips, the ATM vol went up by <span class="math inline">\(0.5\%\)</span> while the the 25 <span class="math inline">\(\Delta\)</span> Put vol went up <span class="math inline">\(0.8\%\)</span> (since the price to hedge from downside has went up because of the underlying so there is more demand for puts).</p>
<p><span class="math display">\[
\begin{align*}
    S_0 &amp;= 1.16 \\
    Date(Today) &amp;= 16/12/2025 \\
    r_d &amp;= 0.03 \\
    r_f &amp;= 0.02 \\
\end{align*}
\]</span></p>
<p>With the following Implied Vol surface</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;"><span class="math inline">\(10\Delta p\)</span></th>
<th style="text-align: left;"><span class="math inline">\(25\Delta p\)</span></th>
<th style="text-align: left;">ATM</th>
<th style="text-align: left;"><span class="math inline">\(25\Delta c\)</span></th>
<th style="text-align: left;"><span class="math inline">\(10\Delta c\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>3D</strong></td>
<td style="text-align: left;">14.00%</td>
<td style="text-align: left;">13.00%</td>
<td style="text-align: left;">12.00%</td>
<td style="text-align: left;">11.50%</td>
<td style="text-align: left;">10.50%</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>1M</strong></td>
<td style="text-align: left;">14.00%</td>
<td style="text-align: left;">13.50%</td>
<td style="text-align: left;">10.00%</td>
<td style="text-align: left;">9.00%</td>
<td style="text-align: left;">9.75%</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>3M</strong></td>
<td style="text-align: left;">12.75%</td>
<td style="text-align: left;">11.50%</td>
<td style="text-align: left;">10.00%</td>
<td style="text-align: left;">9.00%</td>
<td style="text-align: left;">9.50%</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>1Y</strong></td>
<td style="text-align: left;">12.50%</td>
<td style="text-align: left;">10.75%</td>
<td style="text-align: left;">10.25%</td>
<td style="text-align: left;">9.75%</td>
<td style="text-align: left;">9.50%</td>
</tr>
</tbody>
</table>
<p>We are now interested to see what’s the new exposure of our hedging portfolio.</p>
<div id="b47c8352" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ref_date <span class="op">=</span> today <span class="op">+</span> ql.Period(<span class="dv">2</span>, ql.Days)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>spot_quote.setValue(<span class="fl">1.16</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>new_times <span class="op">=</span> [dc.yearFraction(ref_date, m) <span class="cf">for</span> m <span class="kw">in</span> maturities]</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Vol surface</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>new_ivs <span class="op">=</span> np.array([</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0.10P, 0.25P, ATM,  0.25C, 0.10C</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.140</span>, <span class="fl">0.13</span>,  <span class="fl">0.12</span>, <span class="fl">0.115</span>, <span class="fl">0.105</span>],  <span class="co"># 1W </span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.140</span>, <span class="fl">0.135</span>, <span class="fl">0.110</span>, <span class="fl">0.105</span>, <span class="fl">0.10</span>],  <span class="co"># 1M</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1275</span>, <span class="fl">0.115</span>, <span class="fl">0.100</span>, <span class="fl">0.090</span>, <span class="fl">0.095</span>],  <span class="co"># 3M</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.125</span>, <span class="fl">0.1075</span>, <span class="fl">0.1025</span>, <span class="fl">0.0975</span>, <span class="fl">0.105</span>],  <span class="co"># 1Y</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Move vols and expiry time</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>ql.Settings.instance().evaluationDate <span class="op">=</span> ref_date</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s calculate the new strikes needed to build the new calibrated local vol surface.</p>
<div id="ef96aa49" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>new_strikes <span class="op">=</span> create_strike_iv_surf(spot_quote.value(), usd_curve, eur_curve, deltas, option_types, new_times, new_ivs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9cf12bdc" class="cell" data-execution_count="217">
<div class="cell-output cell-output-display" data-execution_count="217">
<pre><code>array([[1.13612881, 1.14837208, 1.16019107, 1.17076404, 1.17858337],
       [1.10412947, 1.13192316, 1.16097287, 1.18435339, 1.20361041],
       [1.07412444, 1.11998689, 1.16256386, 1.19758045, 1.23419363],
       [1.00256954, 1.09219685, 1.16972097, 1.24936665, 1.33944933]])</code></pre>
</div>
</div>
<div id="2c4e457e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ah_vol_surf, ah_local_vol <span class="op">=</span> calibrate_vol_surface(new_strikes, option_types, maturities, new_ivs)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>black_vol_surf_handle.linkTo(ah_vol_surf)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>local_vol_surf_handle.linkTo(ah_local_vol)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5e767378" class="cell" data-execution_count="219">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="exotic-book-local-vol_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We now have to recalculate the price of the hedging vanillas and the value of the new exotics to calculate the <span class="math inline">\(P\&amp;L\)</span> from time <span class="math inline">\(t\)</span> to time <span class="math inline">\(t+1\)</span></p>
<div id="dc6d8113" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(vanilla_options)):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(vanilla_options[<span class="dv">0</span>])):</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>        process <span class="op">=</span> ql.GarmanKohlagenProcess(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>            spot_handle,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>            foreign_ts,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>            domestic_ts,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>            ql.BlackVolTermStructureHandle(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                ql.BlackConstantVol(ref_date, calendar, new_ivs[i, j], dc)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        vanilla_options[i][j].setPricingEngine(ql.AnalyticEuropeanEngine(process))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f445bc9c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>new_premiums <span class="op">=</span> [opt.NPV() <span class="cf">for</span> opt <span class="kw">in</span> book]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>new_book_value <span class="op">=</span> <span class="bu">sum</span>(new_premiums)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>new_vanilla_premiums <span class="op">=</span> [[opt.NPV() <span class="op">*</span> v_w <span class="op">*</span> notional <span class="cf">for</span> opt, v_w <span class="kw">in</span> <span class="bu">zip</span>(row, v_row)] <span class="cf">for</span> row, v_row <span class="kw">in</span> <span class="bu">zip</span>(vanilla_options, vega_weights)]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>spot_premium_eur <span class="op">=</span> hedging_delta_weight <span class="op">*</span> notional </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>new_spot_hedge_usd <span class="op">=</span> hedging_delta_weight <span class="op">*</span> notional <span class="op">*</span> spot_handle.value()</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>new_hedging_str_premium <span class="op">=</span> np.<span class="bu">sum</span>(new_vanilla_premiums) <span class="op">+</span> new_spot_hedge_usd</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6b86709f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> dc.yearFraction(today, ref_date)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>usd_interest_cost <span class="op">=</span> hedging_str_premium <span class="op">*</span> r_d <span class="op">*</span> dt</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>eur_interest_accr <span class="op">=</span> spot_premium_eur <span class="op">*</span> r_f <span class="op">*</span> dt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="326ea5be" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>new_total_portfolio_value <span class="op">=</span> new_hedging_str_premium <span class="op">-</span> np.<span class="bu">sum</span>(new_premiums) <span class="op">+</span> bank_account_value <span class="op">-</span> usd_interest_cost <span class="op">+</span> eur_interest_accr <span class="op">*</span> spot_quote.value()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Portfolio value at time t = 1 is: $</span><span class="sc">{</span>new_total_portfolio_value<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Portfolio value at time t = 1 is: $202.86605298389892</code></pre>
</div>
</div>
<p>Thus the variation from time 0 to time 1 is just about <span class="math inline">\(\$200\)</span>, this confirms that our hedge worked by limiting the variation of the whole portfolio value.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-vol-interpol" class="csl-entry" role="listitem">
Andreasen, Jesper, and Brian Huge. 2010. <span>“Volatility Interpolation.”</span> <em>Risk Magazine</em>, March. <a href="https://doi.org/10.2139/ssrn.1694972">https://doi.org/10.2139/ssrn.1694972</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/your-website-url\.example\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>